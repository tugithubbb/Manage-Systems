name: CI/CD Spring Boot ‚Üí Docker Swarm

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'gradle'

      - name: Build Spring Boot
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker image
        run: |
          docker build -t maingoctu56/management-system:latest .
          docker push maingoctu56/management-system:latest

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Configure SSH known_hosts
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts 2>&1
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ SSH configured for $VPS_HOST"

      - name: Deploy to VPS (Docker Swarm)
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          DOCKER_IMAGE: maingoctu56/management-system
          SERVICE_NAME: management-system
          NETWORK_NAME: app-network
          REPLICAS: 2
          ENV_FILE: /etc/app/management-system.env
        run: |
          chmod +x deploy.sh
          ./deploy.sh

      - name: Verify Deployment
        if: success()
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "üîç Checking service status..."
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'VERIFY'
            echo "üìä Service Status:"
            docker service ls --filter name=management-system
            echo ""
            echo "üìã Service Tasks:"
            docker service ps management-system --no-trunc --format "table {{.ID}}\t{{.Name}}\t{{.Node}}\t{{.DesiredState}}\t{{.CurrentState}}" 2>&1 || echo "Service not ready yet"
            echo ""
            echo "üìù Recent Logs:"
            docker service logs management-system --tail 30 --timestamps 2>&1 || echo "No logs available yet"
          VERIFY

      - name: Deployment Summary
        if: always()
        run: |
          echo "### üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: maingoctu56/management-system:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: management-system" >> $GITHUB_STEP_SUMMARY
          echo "- **Replicas**: 2" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üåê **Application URL**: http://${{ secrets.VPS_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Deployment failed. Check logs above.**" >> $GITHUB_STEP_SUMMARY
          fi